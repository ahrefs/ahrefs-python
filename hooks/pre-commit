#!/usr/bin/env bash
set -e

# Activate project venv if not already in one
if [ -z "$VIRTUAL_ENV" ] && [ -f .venv/bin/activate ]; then
    source .venv/bin/activate
fi

# Stash unstaged changes so we lint exactly what's being committed
has_stash=0
if ! git diff --quiet; then
    git stash push --keep-index --quiet -m "pre-commit stash"
    has_stash=1
fi

cleanup() {
    if [ "$has_stash" -eq 1 ]; then
        git stash pop --quiet
    fi
}
trap cleanup EXIT

make lint
